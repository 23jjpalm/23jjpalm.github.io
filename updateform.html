<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>METAR Weather with Flight Category</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #1a1a1a;
    color: white;
    margin: 0;
    padding: 40px;
    text-align: center;
  }
  h1 {
    margin-bottom: 30px;
  }
  table {
    width: 100%;
    max-width: 900px;
    margin: 30px auto 10px auto;
    border-collapse: collapse;
    text-align: center;
  }
  th, td {
    border: 1px solid #444;
    padding: 8px;
  }
  th {
    background-color: #333;
  }
  caption {
    caption-side: top;
    font-weight: bold;
    font-size: 1.3em;
    margin-bottom: 10px;
  }
  .station-name {
    margin-top: 50px;
    font-size: 1.1em;
    font-weight: bold;
  }
  .raw-metar {
    margin-top: 5px;
    font-family: monospace;
    font-size: 0.9em;
    color: #ccc;
  }
  .category {
    font-weight: bold;
    font-size: 1.1em;
  }
</style>
</head>
<body>

<h1>METAR Weather with Flight Category</h1>

<div id="weatherTables">

  <table id="tableKGHG">
    <caption>Marshfield (KGHG)</caption>
    <thead>
      <tr>
        <th>Wind</th>
        <th>Visibility</th>
        <th>Cloud Coverage</th>
        <th>Temp / Dewpoint (°C)</th>
        <th>Altimeter (inHg)</th>
        <th>Flight Category</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="windKGHG">Loading...</td>
        <td id="visKGHG">Loading...</td>
        <td id="cloudsKGHG">Loading...</td>
        <td id="tempdewKGHG">Loading...</td>
        <td id="altKGHG">Loading...</td>
        <td id="catKGHG">Loading...</td>
      </tr>
    </tbody>
  </table>

  <table id="tableKEWB">
    <caption>New Bedford (KEWB)</caption>
    <thead>
      <tr>
        <th>Wind</th>
        <th>Visibility</th>
        <th>Cloud Coverage</th>
        <th>Temp / Dewpoint (°C)</th>
        <th>Altimeter (inHg)</th>
        <th>Flight Category</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="windKEWB">Loading...</td>
        <td id="visKEWB">Loading...</td>
        <td id="cloudsKEWB">Loading...</td>
        <td id="tempdewKEWB">Loading...</td>
        <td id="altKEWB">Loading...</td>
        <td id="catKEWB">Loading...</td>
      </tr>
    </tbody>
  </table>

</div>

<div id="metarDisplay">
  <p class="station-name">Marshfield Raw METAR:</p>
  <p class="raw-metar" id="metarKGHG">Loading...</p>
  <p class="station-name">New Bedford Raw METAR:</p>
  <p class="raw-metar" id="metarKEWB">Loading...</p>
</div>

<script>
// Helper to fetch raw METAR via proxy (to avoid CORS)
async function fetchRawMetar(station) {
  // aviationweather.gov no longer supports CORS so we use allorigins proxy
  const url = `https://aviationweather.gov/api/data/metar?ids=${station}&format=raw&hoursBeforeNow=1&mostRecent=true`;
  const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
  try {
    const response = await fetch(proxy);
    const json = await response.json();
    // Extract raw METAR from returned contents
    const text = json.contents;
    // Find raw METAR line (usually contains the station code)
    const metarLine = text.split('\n').find(line => line.includes(station));
    return metarLine || "No METAR found";
  } catch (e) {
    return "Error loading METAR";
  }
}

// Parsing functions adapted from toldcard.com repo and FAA criteria

function parseWind(metar) {
  const windRegex = /(\d{3}|VRB)(\d{2})(G(\d{2}))?KT/;
  const m = metar.match(windRegex);
  if (!m) return "N/A";
  const dir = m[1] === "VRB" ? "Variable" : m[1] + "°";
  const speed = m[2];
  const gust = m[4] ? ` gust ${m[4]}` : "";
  return `${dir} at ${speed} kt${gust}`;
}

function parseVisibility(metar) {
  // Look for visibility in statute miles or meters
  let m = metar.match(/ (\d{1,2})SM /);
  if (m) return `${m[1]} SM`;
  m = metar.match(/ (\d{4}) /);
  if (m) {
    let meters = parseInt(m[1], 10);
    let miles = (meters * 0.000621371).toFixed(1);
    return `${miles} SM`;
  }
  return "N/A";
}

function parseClouds(metar) {
  const cloudRegex = /(FEW|SCT|BKN|OVC|VV)\d{3}/g;
  const matches = metar.match(cloudRegex);
  if (!matches) {
    if (metar.includes("SKC") || metar.includes("CLR") || metar.includes("NCD")) return "Clear";
    return "N/A";
  }
  return matches.join(", ");
}

function parseTempDew(metar) {
  const tempDewRegex = / (M?\d{2})\/(M?\d{2}) /;
  const m = metar.match(tempDewRegex);
  if (!m) return "N/A";
  const temp = m[1].replace("M", "-");
  const dew = m[2].replace("M", "-");
  return `${temp} / ${dew}`;
}

function parseAltimeter(metar) {
  let m = metar.match(/ A(\d{4}) /);
  if (m) {
    let inHgHundredths = parseInt(m[1], 10);
    let inHg = (inHgHundredths / 100).toFixed(2);
    return `${inHg} inHg`;
  }
  m = metar.match(/ Q(\d{4}) /);
  if (m) {
    // convert hPa to inHg
    let hPa = parseInt(m[1], 10);
    let inHg = (hPa * 0.02953).toFixed(2);
    return `${inHg} inHg`;
  }
  return "N/A";
}

// Flight Category calculation per FAA definitions (simplified):
// VFR: Visibility > 5 SM and Ceiling > 3000 ft AGL (no BKN/OVC below 3000)
// MVFR: Visibility 3-5 SM or Ceiling 1000-3000 ft AGL
// IFR: Visibility 1-3 SM or Ceiling 500-1000 ft AGL
// LIFR: Visibility < 1 SM or Ceiling < 500 ft AGL

// To get ceiling: lowest BKN or OVC cloud layer height in feet AGL (hundreds of feet * 100)

function getFlightCategory(metar) {
  // Parse visibility in SM (float)
  let visMatch = metar.match(/ (\d{1,2})SM /);
  let vis = visMatch ? parseFloat(visMatch[1]) : null;
  if (!vis) {
    // try meters fallback
    let m = metar.match(/ (\d{4}) /);
    if (m) vis = parseInt(m[1], 10) * 0.000621371;
  }
  if (!vis) vis = 10; // default assume good visibility

  // Parse ceiling (lowest BKN or OVC)
  let cloudLayers = [...metar.matchAll(/(BKN|OVC)(\d{3})/g)];
  let ceilingFeet = null;
  if (cloudLayers.length) {
    ceilingFeet = Math.min(...cloudLayers.map(cloud => parseInt(cloud[2], 10) * 100));
  } else {
    ceilingFeet = 99999; // No ceiling reported, assume sky clear
  }

  // Flight category logic
  if (vis >= 5 && ceilingFeet > 3000) return "VFR";
  if ((vis >= 3 && vis < 5) || (ceilingFeet >= 1000 && ceilingFeet <= 3000)) return "MVFR";
  if ((vis >= 1 && vis < 3) || (ceilingFeet >= 500 && ceilingFeet < 1000)) return "IFR";
  if (vis < 1 || ceilingFeet < 500) return "LIFR";

  return "VFR"; // default safe fallback
}

async function updateMetar(station, suffix) {
  const rawMetar = await fetchRawMetar(station);
  document.getElementById(`metar${suffix}`).textContent = rawMetar;

  document.getElementById(`wind${suffix}`).textContent = parseWind(rawMetar);
  document.getElementById(`vis${suffix}`).textContent = parseVisibility(rawMetar);
  document.getElementById(`clouds${suffix}`).textContent = parseClouds(rawMetar);
  document.getElementById(`tempdew${suffix}`).textContent = parseTempDew(rawMetar);
  document.getElementById(`alt${suffix}`).textContent = parseAltimeter(rawMetar);
  document.getElementById(`cat${suffix}`).textContent = getFlightCategory(rawMetar);
}

updateMetar("KGHG", "KGHG");
updateMetar("KEWB", "KEWB");
</script>

</body>
</html>
